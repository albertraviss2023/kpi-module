<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Dashboard</title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .trend-cell {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .trend-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .kpi-table {
            width: 100%;
            border-collapse: collapse;
        }
        .kpi-table th, .kpi-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .kpi-table th {
            background-color: #f3f4f6;
            font-weight: bold;
            color: #1f2937;
        }
        .dark .kpi-table th {
            background-color: #374151;
            color: #e5e7eb;
        }
        .kpi-table tr:hover {
            background-color: #f9fafb;
        }
        .dark .kpi-table tr:hover {
            background-color: #4b5563;
        }
        .thumbnail-chart {
            width: 100px;
            height: 50px;
            display: block;
            margin: 0 auto;
        }
        .kpi-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: #00A65A;
            color: #ffffff;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col min-h-screen">

    <div id="notification-area" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-[#00A65A]"></div>
    </div>

    <div id="landing-page" class="flex-grow flex items-center justify-center p-6">
        <div class="text-center bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full">
            <img src="/static/logo.png" alt="National Drug Authority Logo" class="mx-auto mb-4 h-16 w-auto">
            <h1 class="text-6xl font-extrabold mb-3 tracking-tight text-center" style="color: #01924F  !important;"> NATIONAL DRUG AUTHORITY </h1>
            <h2 class="text-xl text-[#00A65A] mb-6 text-center">Regulatory Performance KPI Dashboard</h2>
            <button id="enter-dashboard-btn" class="text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
  style="background-color: #00A65A;" onmouseover="this.style.backgroundColor='#008B45'" onmouseout="this.style.backgroundColor='#00A65A'"
>
  Enter Dashboard
</button>

        </div>
    </div>

    <div id="dashboard-page" class="hidden flex-grow flex flex-col p-6">
        <header class="flex flex-col items-center mb-8 space-y-4">
            <div class="text-center">
                <img src="/static/logo.png" alt="National Drug Authority Logo" class="mx-auto mb-4 h-20 w-auto">
                <h1 class="text-6xl font-extrabold mb-3 tracking-tight text-center" style="color: #01924F  !important;"> NATIONAL DRUG AUTHORITY </h1>
                <h2 class="text-xl font-semibold text-[#00A65A] text-center">REGULATORY PERFORMANCE KPI DASHBOARD</h2>
            </div>
            <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <div class="flex items-center space-x-2">
                    <label for="year-filter" class="text-gray-700 dark:text-gray-300 font-medium">Year:</label>
                    <select id="year-filter" class="p-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-[#00A65A] focus:border-[#00A65A]">
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="quarter-filter" class="text-gray-700 dark:text-gray-300 font-medium">Quarter:</label>
                    <select id="quarter-filter" class="p-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-[#00A65A] focus:border-[#00A65A]">
                        <option value="">All Quarters</option>
                        <option value="Q1">Q1</option>
                        <option value="Q2">Q2</option>
                        <option value="Q3">Q3</option>
                        <option value="Q4">Q4</option>
                    </select>
                </div>
                <div class="relative">
                    <button
  id="export-btn"
  class="text-white font-bold py-2 px-4 rounded-md shadow transition duration-200 ease-in-out flex items-center"
  style="background-color: #00A65A;"
  onmouseover="this.style.backgroundColor='#008B45'"
  onmouseout="this.style.backgroundColor='#00A65A'"
>
  <i class="fas fa-file-excel mr-2"></i> Export Data <i class="fas fa-chevron-down ml-2"></i>
</button>

                    <div id="export-dropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 z-10 hidden">
                        <a href="#" id="export-selected-btn" class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Export Selected Years</a>
                        <a href="#" id="export-all-btn" class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Export All Data</a>
                    </div>
                </div>
            </div>
        </header>

        <nav class="mb-6">
            <div class="flex space-x-2 sm:space-x-4 border-b border-gray-200 dark:border-gray-700 pb-2 overflow-x-auto">
                <button class="tab-btn active bg-[#00A65A] text-white px-5 py-2 rounded-md font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105" data-tab="ma">Market Authorization</button>
                <button class="tab-btn bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 px-5 py-2 rounded-md font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105" data-tab="ct">Clinical Trials</button>
                <button class="tab-btn bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 px-5 py-2 rounded-md font-semibold shadow-md transition duration-300 ease-in-out transform hover:scale-105" data-tab="gmp">GMP Compliance</button>
            </div>
        </nav>

        <main class="flex-grow">
            <div id="ma-tab" class="tab-content animate-fadeIn">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Overall KPI Status</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="maStatusPieChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Year-over-Year Performance</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="maYoyPieChart"></canvas>
                        </div>
                    </div>
                </div>
                <div id="ma-kpis" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <table class="kpi-table">
                        <thead>
                            <tr>
                                <th class="w-12">No.</th>
                                <th>KPI Name</th>
                                <th>Quarter</th>
                                <th>Value</th>
                                <th>Status</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="ct-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 mdgrid-cols-2 gap-6 mb-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Overall KPI Status</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="ctStatusPieChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Year-over-Year Performance</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="ctYoyPieChart"></canvas>
                        </div>
                    </div>
                </div>
                <div id="ct-kpis" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <table class="kpi-table">
                        <thead>
                            <tr>
                                <th class="w-12">No.</th>
                                <th>KPI Name</th>
                                <th>Quarter</th>
                                <th>Value</th>
                                <th>Status</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="gmp-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Overall KPI Status</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="gmpStatusPieChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Year-over-Year Performance</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="gmpYoyPieChart"></canvas>
                        </div>
                    </div>
                </div>
                <div id="gmp-kpis" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <table class="kpi-table">
                        <thead>
                            <tr>
                                <th class="w-12">No.</th>
                                <th>KPI Name</th>
                                <th>Quarter</th>
                                <th>Value</th>
                                <th>Status</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="trend-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-40 hidden opacity-0 transition-opacity duration-300">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl p-6 relative transform scale-95 transition-all duration-300">
            <button id="close-trend-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-2xl font-bold">×</button>
            <h3 id="trend-kpi-title" class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">KPI Trend</h3>
            <div class="chart-container" style="height: 400px;">
                <canvas id="kpiTrendChart"></canvas>
            </div>
        </div>
    </div>

    <div id="export-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-40 hidden opacity-0 transition-opacity duration-300">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative transform scale-95 transition-all duration-300">
            <button id="close-export-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-2xl font-bold">×</button>
            <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">Select Years for Export</h3>
            <div id="year-checkboxes" class="grid grid-cols-2 gap-3 mb-6 max-h-60 overflow-y-auto pr-2">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-export-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-200 ease-in-out">Cancel</button>
                <button id="confirm-export-btn" class="bg-[#00A65A] hover:bg-[#008B45] text-white font-bold py-2 px-4 rounded-md transition duration-200 ease-in-out">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- Constants and Global Variables ---
        const API_BASE_URL = 'http://localhost:8000';
        const AUTH_CREDENTIALS = 'Basic ' + btoa('kpi_user:kpipassword'); // Replace with your credentials

        const fullDatasetCache = {};
        let kpiTrendChartInstance = null; // Single instance for modal chart
        const statusPieChartInstances = {};
        const yoyPieChartInstances = {};
        const thumbnailChartInstances = {};

        const kpiNameMap = {
            // Marketing Authorization KPIs
            'pct_new_apps_evaluated_on_time': 'Percentage of new applications for marketing authorization of medicines evaluated within a specified time',
            'pct_renewal_apps_evaluated_on_time': 'Percentage of renewals applications for marketing authorization of medicines evaluated within a specified time', 
            'pct_variation_apps_evaluated_on_time': 'Percentage of applications for variation of registered medicinal products evaluated within a specified time',
            'pct_fir_responses_on_time': 'Percentage of further information requests responses received within a specified timeline',
            'pct_query_responses_evaluated_on_time': 'Percentage of query responses/additional data evaluated within a specified time',
            'pct_granted_within_90_days': 'Percentage of medical products and technologies granted MA within 90 working days',
            'median_duration_continental': 'Median timelines taken by NDA to process continentally reviewed application from the time it is received to decision (days)',
            // Clinical Trials KPIs
            'pct_new_apps_evaluated_on_time': 'Percentage of new clinical trial applications evaluated within timeline',
            'pct_amendment_apps_evaluated_on_time': 'Percentage of clinical trial amendments evaluated within timeline',
            'pct_gcp_inspections_on_time': 'Percentage of approved & ongoing clinical trials inspected as per the GCP plan',
            'pct_safety_reports_assessed_on_time': 'Percentage of safety reports assessed within timeline',
            'pct_gcp_compliant': 'Percentage of clinical trials compliant with GCP requirements',
            'pct_registry_submissions_on_time': 'Percentage of clinical trials registered in national registry',
            'pct_capa_evaluated_on_time': 'Percentage of CAPA evaluations completed within timeline',
            'avg_turnaround_time': 'Average turnaround time for clinical trial applications (days)',
            // GMP Compliance KPIs
            'pct_facilities_inspected_on_time': 'Percentage of manufacturing facilities inspected for GMP as per plan',
            'pct_complaint_inspections_on_time': 'Percentage of complaint-triggered GMP inspections conducted at pharmaceutical manufacturing facilities',
            'pct_inspections_waived_on_time': 'Percentage of GMP on-site inspections waived for pharmaceutical manufacturing facilities within set timelines',
            'pct_facilities_compliant': 'Percentage of pharmaceutical manufacturing facilities compliant with GMP requirements',
            'pct_capa_decisions_on_time': 'Percentage of final CAPA decisions issued within a specified timeline',
            'pct_applications_completed_on_time': 'Percentage of GMP inspection applications for pharmaceutical manufacturing facilities completed within the set timeline',
            'avg_turnaround_time': 'Average turnaround time (in days) to complete GMP applications for pharmaceutical manufacturing facilities',
            'median_turnaround_time': 'Median turnaround time (in days) to complete GMP inspection applications for pharmaceutical manufacturing facilities',
            'pct_reports_published_on_time': 'Percentage of GMP inspection reports published on the regulator’s website within a specified timeline'
        };

        const percentageKpis = [
            'pct_new_apps_evaluated_on_time',
            'pct_renewal_apps_evaluated_on_time',
            'pct_variation_apps_evaluated_on_time',
            'pct_fir_responses_on_time',
            'pct_query_responses_evaluated_on_time',
            'pct_granted_within_90_days',
            'pct_amendment_apps_evaluated_on_time',
            'pct_gcp_inspections_on_time',
            'pct_safety_reports_assessed_on_time',
            'pct_gcp_compliant',
            'pct_registry_submissions_on_time',
            'pct_capa_evaluated_on_time',
            'pct_facilities_inspected_on_time',
            'pct_complaint_inspections_on_time',
            'pct_inspections_waived_on_time',
            'pct_facilities_compliant',
            'pct_capa_decisions_on_time',
            'pct_applications_completed_on_time',
            'pct_reports_published_on_time'
        ];

        // --- Utility Functions ---

        function showNotification(message, type = 'info', duration = 3000) {
            const notificationArea = document.getElementById('notification-area');
            const notification = document.createElement('div');
            notification.className = `p-4 rounded-md shadow-md text-white flex items-center transform transition-all duration-300 ease-out translate-x-full opacity-0`;

            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-600';
            else if (type === 'error') bgColor = 'bg-red-500';
            else if (type === 'warning') bgColor = 'bg-yellow-500';

            notification.classList.add(bgColor);
            notification.innerHTML = `<i class="fas fa-info-circle mr-3"></i> ${message}`;

            if (type === 'success') notification.querySelector('i').className = 'fas fa-check-circle mr-3';
            else if (type === 'error') notification.querySelector('i').className = 'fas fa-times-circle mr-3';
            else if (type === 'warning') notification.querySelector('i').className = 'fas fa-exclamation-triangle mr-3';

            notificationArea.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
                notification.classList.add('translate-x-0', 'opacity-100');
            }, 50);

            setTimeout(() => {
                notification.classList.remove('translate-x-0', 'opacity-100');
                notification.classList.add('translate-x-full', 'opacity-0');
                notification.addEventListener('transitionend', () => notification.remove(), { once: true });
            }, duration);
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        function extractYearFromQuarter(quarterString) {
            if (!quarterString || typeof quarterString !== 'string') return null;
            const parts = quarterString.split('Q');
            return parseInt(parts[0]);
        }

        function formatQuarterDisplay(quarterString) {
            if (!quarterString || typeof quarterString !== 'string') return 'N/A';
            const year = extractYearFromQuarter(quarterString);
            const quarterNum = quarterString.split('Q')[1];
            return `Q${quarterNum} ${year}`;
        }

        function formatValue(kpiKey, value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            if (percentageKpis.includes(kpiKey)) {
                const parsedValue = parseFloat(value);
                return parsedValue >= 0 && parsedValue <= 1000 ? `${parsedValue.toFixed(1)}%` : 'Invalid';
            } else if (['median_duration_continental', 'avg_turnaround_time', 'median_turnaround_time'].includes(kpiKey)) {
                return `${parseFloat(value).toFixed(0)} days`;
            }
            return parseFloat(value).toLocaleString();
        }

        function getKpiStatus(kpiName, value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            value = parseFloat(value);
            if (percentageKpis.includes(kpiName)) {
                if (value < 0 || value > 10000) return 'Invalid';
                if (value >= 90) return 'On Target';
                if (value >= 70 && value < 90) return 'Needs Attention';
                return 'Below Target';
            }
            const targetInfo = {
                'median_duration_continental': { target: 30, type: 'lessThan', threshold: 45 },
                'avg_turnaround_time': { target: 30, type: 'lessThan', threshold: 45 },
                'median_turnaround_time': { target: 30, type: 'lessThan', threshold: 45 }
            }[kpiName] || { target: 0, type: 'greaterThan', threshold: 0 };

            if (targetInfo.type === 'greaterThan') {
                if (value >= targetInfo.target) return 'On Target';
                if (targetInfo.threshold && value >= targetInfo.threshold) return 'Needs Attention';
                return 'Below Target';
            } else if (targetInfo.type === 'lessThan') {
                if (value <= targetInfo.target) return 'On Target';
                if (targetInfo.threshold && value <= targetInfo.threshold) return 'Needs Attention';
                return 'Below Target';
            }
            return 'N/A';
        }

        function getStatusColorClass(status) {
            switch (status) {
                case 'On Target': return 'bg-green-600 text-white dark:bg-green-500 dark:text-white';
                case 'Needs Attention': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100';
                case 'Below Target': return 'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100';
                case 'N/A': return 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200';
                case 'Invalid': return 'bg-red-200 text-red-900 dark:bg-red-900 dark:text-red-200';
                default: return 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-100';
            }
        }

        function getTrendStatus(currentVal, prevVal, kpiKey) {
            if (currentVal === null || prevVal === null || currentVal === undefined || prevVal === undefined || isNaN(currentVal) || isNaN(prevVal)) {
                return 'N/A';
            }
            currentVal = parseFloat(currentVal);
            prevVal = parseFloat(prevVal);
            const isLessThanBetter = ['median_duration_continental', 'avg_turnaround_time', 'median_turnaround_time'].includes(kpiKey);
            
            if (isLessThanBetter) {
                if (currentVal < prevVal) return 'Improved';
                if (currentVal > prevVal) return 'Declined';
                return 'Stable';
            } else {
                if (currentVal > prevVal) return 'Improved';
                if (currentVal < prevVal) return 'Declined';
                return 'Stable';
            }
        }

        function renderThumbnailChart(canvasId, kpiName, process, data) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) {
                console.error(`Canvas not found for ${canvasId}`);
                return;
            }
            const chartKey = `${process}_${kpiName}_${canvasId}`;

            // Destroy existing thumbnail chart if it exists
            if (thumbnailChartInstances[chartKey]) {
                thumbnailChartInstances[chartKey].destroy();
                delete thumbnailChartInstances[chartKey];
            }

            // Filter and sort data
            const validData = data.filter(item => item[kpiName] !== null && item[kpiName] !== undefined && !isNaN(item[kpiName]));
            console.log(`Rendering thumbnail for ${chartKey}, valid data points:`, validData);

            if (validData.length === 0) {
                ctx.font = '12px Arial';
                ctx.fillStyle = '#4B5563';
                ctx.textAlign = 'center';
                ctx.fillText('No data', 50, 25);
                return;
            }

            validData.sort((a, b) => {
                const yearA = extractYearFromQuarter(a.quarter) || 0;
                const qtrA = a.quarter && a.quarter.includes('Q') ? parseInt(a.quarter.substring(a.quarter.indexOf('Q') + 1)) : 0;
                const yearB = extractYearFromQuarter(b.quarter) || 0;
                const qtrB = b.quarter && b.quarter.includes('Q') ? parseInt(b.quarter.substring(b.quarter.indexOf('Q') + 1)) : 0;
                if (yearA !== yearB) return yearA - yearB;
                return qtrA - qtrB;
            });

            const labels = validData.map(item => formatQuarterDisplay(item.quarter));
            const kpiValues = validData.map(item => parseFloat(item[kpiName]));

            thumbnailChartInstances[chartKey] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: kpiValues,
                        borderColor: '#00A65A',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: false,
                        pointRadius: validData.length === 1 ? 4 : 2,
                        pointBackgroundColor: '#00A65A',
                        hoverRadius: validData.length === 1 ? 6 : 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        title: { display: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    elements: {
                        line: { borderWidth: 2 },
                        point: { radius: validData.length === 1 ? 4 : 2 }
                    },
                    animation: false
                }
            });
        }

        function populateKPIs(kpiData, process, year, quarter) {
            const container = document.getElementById(`${process}-kpis`).querySelector('tbody');
            container.innerHTML = '';
            console.log(`Populating KPIs for ${process}, year: ${year}, quarter: ${quarter || 'all'}`, kpiData);

            // Clear existing thumbnail charts for this process
            Object.keys(thumbnailChartInstances)
                .filter(key => key.startsWith(`${process}_`))
                .forEach(key => {
                    if (thumbnailChartInstances[key]) {
                        thumbnailChartInstances[key].destroy();
                        delete thumbnailChartInstances[key];
                    }
                });

            if (!kpiData || kpiData.length === 0) {
                container.innerHTML = `<tr><td colspan="6" class="text-gray-600 dark:text-gray-400 text-center">No data available for ${process.toUpperCase()} in ${year} ${quarter || 'all quarters'}.</td></tr>`;
                showNotification(`No KPI data found for ${process.toUpperCase()} in ${year} ${quarter || 'all quarters'}.`, "warning");
                return;
            }

            let kpiCounter = 1; // Initialize counter for KPI numbering
            kpiData.forEach(item => {
                const itemKeys = Object.keys(item).filter(key => !['id', 'quarter', 'run_date', 'year'].includes(key) && kpiNameMap[key]);
                console.log(`Processing item for ${process}, quarter: ${item.quarter}, keys:`, itemKeys);

                itemKeys.forEach(kpiKey => {
                    const value = item[kpiKey];
                    const formattedValue = formatValue(kpiKey, value);
                    const status = getKpiStatus(kpiKey, value);
                    const statusColorClass = getStatusColorClass(status);

                    const previousYear = parseInt(year) - 1;
                    const previousQuarterFullString = quarter ? `${previousYear}${quarter}` : `${previousYear}${item.quarter.split('Q')[1]}`;
                    const previousData = fullDatasetCache[process]?.find(d => d.quarter === previousQuarterFullString);
                    const prevValue = previousData ? previousData[kpiKey] : null;
                    const trend = getTrendStatus(value, prevValue, kpiKey);

                    const kpiNameDisplay = kpiNameMap[kpiKey] || kpiKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const canvasId = `thumbnail-${process}-${kpiKey}-${item.quarter.replace('Q', '-')}`;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="kpi-number">${kpiCounter}</span></td>
                        <td>${kpiNameDisplay}</td>
                        <td>${formatQuarterDisplay(item.quarter)}</td>
                        <td>${formattedValue}</td>
                        <td><span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${statusColorClass}">${status}</span></td>
                        <td><canvas id="${canvasId}" class="trend-cell thumbnail-chart" data-kpi="${kpiKey}" data-process="${process}"></canvas></td>
                    `;
                    container.appendChild(row);
                    kpiCounter++; // Increment counter for each KPI

                    // Render thumbnail chart
                    try {
                        renderThumbnailChart(canvasId, kpiKey, process, fullDatasetCache[process] || kpiData);
                    } catch (error) {
                        console.error(`Error rendering thumbnail for ${canvasId}:`, error);
                        const canvas = document.getElementById(canvasId);
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.font = '12px Arial';
                            ctx.fillStyle = '#4B5563';
                            ctx.textAlign = 'center';
                            ctx.fillText('No data', 50, 25);
                        }
                    }
                });
            });

            if (container.innerHTML === '') {
                container.innerHTML = `<tr><td colspan="6" class="text-gray-600 dark:text-gray-400 text-center">No valid KPIs found for ${process.toUpperCase()} in ${year} ${quarter || 'all quarters'}.</td></tr>`;
                showNotification(`No valid KPIs found for ${process.toUpperCase()} in selected period.`, "warning");
            }
        }

        function calculateStatusCounts(kpiData) {
            let statusCounts = { 'On Target': 0, 'Needs Attention': 0, 'Below Target': 0, 'N/A': 0, 'Invalid': 0 };
            if (!kpiData || kpiData.length === 0) return statusCounts;

            kpiData.forEach(item => {
                Object.keys(item)
                    .filter(key => kpiNameMap[key])
                    .forEach(kpiKey => {
                        const value = item[kpiKey];
                        const status = getKpiStatus(kpiKey, value);
                        statusCounts[status]++;
                    });
            });
            console.log('Status counts:', statusCounts);
            return statusCounts;
        }

        function renderStatusPieChart(process, statusCounts) {
            const ctx = document.getElementById(`${process}StatusPieChart`).getContext('2d');

            if (statusPieChartInstances[process]) {
                statusPieChartInstances[process].destroy();
            }

            statusPieChartInstances[process] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['On Target', 'Needs Attention', 'Below Target', 'N/A', 'Invalid'],
                    datasets: [{
                        data: [statusCounts['On Target'], statusCounts['Needs Attention'], statusCounts['Below Target'], statusCounts['N/A'], statusCounts['Invalid']],
                        backgroundColor: [
                            '#16a34a',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(159, 162, 180, 0.8)',
                            'rgba(220, 38, 38, 0.8)'
                        ],
                        borderColor: [
                            '#00A65A',
                            'rgba(249, 115, 22, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(159, 162, 180, 1)',
                            'rgba(220, 38, 38, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#E5E7EB'
                            }
                        },
                        title: {
                            display: true,
                            text: `${process.toUpperCase()} KPI Status Overview`,
                            color: '#1F2937'
                        }
                    }
                }
            });
        }

        function calculateYoyCounts(currentQuarterData, previousYearSameQuarterData) {
            let yoyCounts = { 'Improved': 0, 'Declined': 0, 'Stable': 0, 'N/A': 0 };
            if (!currentQuarterData || !previousYearSameQuarterData) return yoyCounts;

            Object.keys(currentQuarterData)
                .filter(key => kpiNameMap[key])
                .forEach(kpiKey => {
                    const currentVal = currentQuarterData[kpiKey];
                    const prevVal = previousYearSameQuarterData[kpiKey];

                    if (currentVal === null || prevVal === null || currentVal === undefined || prevVal === undefined || isNaN(currentVal) || isNaN(prevVal)) {
                        yoyCounts['N/A']++;
                        return;
                    }

                    const trend = getTrendStatus(currentVal, prevVal, kpiKey);
                    yoyCounts[trend]++;
                });
            console.log('YOY counts:', yoyCounts);
            return yoyCounts;
        }

        function renderYoyPieChart(process, yoyCounts) {
            const ctx = document.getElementById(`${process}YoyPieChart`).getContext('2d');

            if (yoyPieChartInstances[process]) {
                yoyPieChartInstances[process].destroy();
            }

            yoyPieChartInstances[process] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Improved', 'Declined', 'Stable', 'N/A'],
                    datasets: [{
                        data: [yoyCounts.Improved, yoyCounts.Declined, yoyCounts.Stable, yoyCounts['N/A']],
                        backgroundColor: [
                            '#16a34a',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(159, 162, 180, 0.8)'
                        ],
                        borderColor: [
                            '#00A65A',
                            'rgba(239, 68, 68, 1)',
                            'rgba(249, 115, 22, 1)',
                            'rgba(159, 162, 180, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#E5E7EB'
                            }
                        },
                        title: {
                            display: true,
                            text: `${process.toUpperCase()} Year-over-Year Performance`,
                            color: '#1F2937'
                        }
                    }
                }
            });
        }

        async function loadKPIs(process, year, quarter) {
            showLoading(true);
            try {
                let data = fullDatasetCache[process];
                if (!data) {
                    console.log(`Fetching data for ${process} from ${API_BASE_URL}/${process}`);
                    const response = await fetch(`${API_BASE_URL}/${process}`, {
                        headers: { 'Authorization': AUTH_CREDENTIALS }
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    data = await response.json();
                    console.log(`Received data for ${process}:`, data);
                    fullDatasetCache[process] = data;
                }

                if (!data || !Array.isArray(data) || data.length === 0) {
                    console.warn(`No valid data received for ${process}`);
                    const container = document.getElementById(`${process}-kpis`).querySelector('tbody');
                    container.innerHTML = `<tr><td colspan="6" class="text-gray-600 dark:text-gray-400 text-center">No data available for ${process.toUpperCase()}.</td></tr>`;
                    renderStatusPieChart(process, { 'On Target': 0, 'Needs Attention': 0, 'Below Target': 0, 'N/A': 0, 'Invalid': 0 });
                    renderYoyPieChart(process, { 'Improved': 0, 'Declined': 0, 'Stable': 0, 'N/A': 0 });
                    showNotification(`No data available for ${process.toUpperCase()}.`, "warning");
                    return;
                }

                let filteredData = data.filter(item => {
                    if (!item.quarter || typeof item.quarter !== 'string') return false;
                    const itemYear = extractYearFromQuarter(item.quarter);
                    const itemQuarterPart = item.quarter.substring(item.quarter.indexOf('Q'));
                    return itemYear === parseInt(year) && (quarter === '' || itemQuarterPart === quarter);
                });

                filteredData.sort((a, b) => {
                    const yearA = extractYearFromQuarter(a.quarter);
                    const qtrA = parseInt(a.quarter.substring(a.quarter.indexOf('Q') + 1));
                    const yearB = extractYearFromQuarter(b.quarter);
                    const qtrB = parseInt(b.quarter.substring(b.quarter.indexOf('Q') + 1));

                    if (yearA !== yearB) return yearB - yearA;
                    return qtrB - qtrA;
                });

                populateKPIs(filteredData, process, year, quarter);

                const statusCounts = calculateStatusCounts(filteredData);
                renderStatusPieChart(process, statusCounts);

                const currentQuarterData = filteredData[0];
                const previousYear = parseInt(year) - 1;
                const previousQuarterFullString = quarter ? `${previousYear}${quarter}` : (filteredData[0] ? filteredData[0].quarter.split('Q')[1] : '');
                const previousYearSameQuarterData = data.find(item => item.quarter === previousQuarterFullString);
                const yoyCounts = calculateYoyCounts(currentQuarterData, previousYearSameQuarterData);
                renderYoyPieChart(process, yoyCounts);

            } catch (error) {
                console.error(`Error loading ${process} KPIs:`, error);
                showNotification(`Failed to load ${process.toUpperCase()} KPIs: ${error.message}`, "error");
                const container = document.getElementById(`${process}-kpis`).querySelector('tbody');
                container.innerHTML = `<tr><td colspan="6" class="text-red-500 dark:text-red-400 text-center">Error loading data: ${error.message}</td></tr>`;
                renderStatusPieChart(process, { 'On Target': 0, 'Needs Attention': 0, 'Below Target': 0, 'N/A': 0, 'Invalid': 0 });
                renderYoyPieChart(process, { 'Improved': 0, 'Declined': 0, 'Stable': 0, 'N/A': 0 });
            } finally {
                showLoading(false);
            }
        }

        async function showTrendChart(kpiName, process) {
            showLoading(true);
            const trendModal = document.getElementById('trend-modal');
            const kpiTrendChartCanvas = document.getElementById('kpiTrendChart');
            const trendKpiTitle = document.getElementById('trend-kpi-title');

            try {
                const displayKpiName = kpiNameMap[kpiName] || kpiName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                trendKpiTitle.textContent = `${displayKpiName} Trend for ${process.toUpperCase()}`;

                let data = fullDatasetCache[process];
                if (!data) {
                    console.log(`Fetching data for trend chart: ${process}/${kpiName}`);
                    const response = await fetch(`${API_BASE_URL}/${process}`, {
                        headers: { 'Authorization': AUTH_CREDENTIALS }
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    data = await response.json();
                    console.log(`Trend chart data for ${process}:`, data);
                    fullDatasetCache[process] = data;
                }

                if (!data || !Array.isArray(data) || data.length === 0) {
                    throw new Error(`No data available for ${process} trend chart.`);
                }

                data.sort((a, b) => {
                    if (!a.quarter || !b.quarter) return 0;
                    const yearA = extractYearFromQuarter(a.quarter) || 0;
                    const qtrA = a.quarter && a.quarter.includes('Q') ? parseInt(a.quarter.substring(a.quarter.indexOf('Q') + 1)) : 0;
                    const yearB = extractYearFromQuarter(b.quarter) || 0;
                    const qtrB = b.quarter && b.quarter.includes('Q') ? parseInt(b.quarter.substring(b.quarter.indexOf('Q') + 1)) : 0;

                    if (yearA !== yearB) return yearA - yearB;
                    return qtrA - qtrB;
                });

                const validData = data.filter(item => item[kpiName] !== null && item[kpiName] !== undefined && !isNaN(item[kpiName]));
                console.log(`Valid data points for ${process}/${kpiName}:`, validData);

                if (validData.length < 1) {
                    throw new Error(`No valid data points available for ${kpiName} trend chart.`);
                }

                const labels = validData.map(item => formatQuarterDisplay(item.quarter));
                const kpiValues = validData.map(item => parseFloat(item[kpiName]));

                // Destroy existing trend chart instance if it exists
                if (kpiTrendChartInstance) {
                    kpiTrendChartInstance.destroy();
                    kpiTrendChartInstance = null;
                }

                kpiTrendChartInstance = new Chart(kpiTrendChartCanvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: displayKpiName,
                            data: kpiValues,
                            borderColor: '#00A65A',
                            tension: 0.1,
                            fill: false,
                            pointRadius: validData.length === 1 ? 8 : 5,
                            pointBackgroundColor: '#00A65A',
                            hoverRadius: validData.length === 1 ? 10 : 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#E5E7EB'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatValue(kpiName, context.raw)}`;
                                    }
                                }
                            },
                            title: {
                                display: validData.length === 1,
                                text: validData.length === 1 ? 'Only one data point available' : '',
                                color: '#1F2937'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Quarter',
                                    color: '#D1D5DB'
                                },
                                ticks: {
                                    color: '#9CA3AF'
                                },
                                grid: {
                                    color: 'rgba(100, 100, 100, 0.2)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: percentageKpis.includes(kpiName) ? 'Percentage (%)' : 'Days',
                                    color: '#D1D5DB'
                                },
                                ticks: {
                                    color: '#9CA3AF',
                                    callback: function(value) {
                                        return formatValue(kpiName, value);
                                    }
                                },
                                grid: {
                                    color: 'rgba(100, 100, 100, 0.2)'
                                }
                            }
                        }
                    }
                });

                trendModal.classList.remove('hidden');
                setTimeout(() => {
                    trendModal.classList.add('opacity-100');
                    trendModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                    trendModal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
                }, 10);
            } catch (error) {
                console.error(`Error showing trend chart for ${kpiName} in ${process}:`, error);
                showNotification(`Failed to display trend chart for ${kpiNameMap[kpiName] || kpiName}: ${error.message}`, "error");
                if (kpiTrendChartInstance) {
                    kpiTrendChartInstance.destroy();
                    kpiTrendChartInstance = null;
                }
                kpiTrendChartCanvas.getContext('2d').clearRect(0, 0, kpiTrendChartCanvas.width, kpiTrendChartCanvas.height);
                kpiTrendChartCanvas.getContext('2d').font = '16px Arial';
                kpiTrendChartCanvas.getContext('2d').fillStyle = '#1F2937';
                kpiTrendChartCanvas.getContext('2d').fillText('No data available for trend chart', 20, 200);
            } finally {
                showLoading(false);
            }
        }

        function populateYearFilter(currentYear = new Date().getFullYear()) {
            const yearFilter = document.getElementById('year-filter');
            yearFilter.innerHTML = '';

            const years = new Set();
            ['ma', 'ct', 'gmp'].forEach(process => {
                if (fullDatasetCache[process]) {
                    fullDatasetCache[process].forEach(item => {
                        const year = extractYearFromQuarter(item.quarter);
                        if (year) years.add(year);
                    });
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a);

            if (sortedYears.length === 0) {
                sortedYears.push(currentYear);
            }

            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearFilter.appendChild(option);
            });

            if (!yearFilter.value && sortedYears.length > 0) {
                yearFilter.value = sortedYears[0];
            } else if (sortedYears.length === 0) {
                const option = document.createElement('option');
                option.value = currentYear;
                option.textContent = currentYear;
                yearFilter.appendChild(option);
                yearFilter.value = currentYear;
            }
        }

        function showExportModal() {
            return new Promise((resolve, reject) => {
                const modal = document.getElementById('export-modal');
                const yearCheckboxesContainer = document.getElementById('year-checkboxes');
                const cancelBtn = document.getElementById('cancel-export-btn');
                const confirmBtn = document.getElementById('confirm-export-btn');
                const closeBtn = document.getElementById('close-export-modal');

                yearCheckboxesContainer.innerHTML = '';

                const allYears = new Set();
                ['ma', 'ct', 'gmp'].forEach(process => {
                    if (fullDatasetCache[process]) {
                        fullDatasetCache[process].forEach(item => {
                            const year = extractYearFromQuarter(item.quarter);
                            if (year) allYears.add(year);
                        });
                    }
                });
                const sortedAllYears = Array.from(allYears).sort((a, b) => b - a);

                if (sortedAllYears.length === 0) {
                    showNotification("No data available to select years for export.", "warning");
                    resolve(null);
                    return;
                }

                sortedAllYears.forEach(year => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input type="checkbox" id="year-${year}" value="${year}" class="form-checkbox h-5 w-5 text-[#00A65A] rounded focus:ring-[#00A65A] dark:bg-gray-700 dark:border-gray-600">
                        <label for="year-${year}" class="ml-2 text-gray-700 dark:text-gray-300">${year}</label>
                    `;
                    yearCheckboxesContainer.appendChild(div);
                });

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('opacity-100');
                    modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                    modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
                }, 10);

                const cleanup = () => {
                    cancelBtn.removeEventListener('click', onCancel);
                    confirmBtn.removeEventListener('click', onConfirm);
                    closeBtn.removeEventListener('click', onCancel);
                    modal.removeEventListener('click', onOutsideClick);
                };

                const onCancel = () => {
                    modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
                    modal.addEventListener('transitionend', function handler() {
                        modal.classList.add('hidden');
                        modal.removeEventListener('transitionend', handler);
                        cleanup();
                        resolve(null);
                    }, { once: true });
                };

                const onConfirm = () => {
                    const selectedYears = Array.from(modal.querySelectorAll('input[type="checkbox"]:checked'))
                        .map(checkbox => parseInt(checkbox.value));

                    modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
                    modal.addEventListener('transitionend', function handler() {
                        modal.classList.add('hidden');
                        modal.removeEventListener('transitionend', handler);
                        cleanup();
                        resolve(selectedYears);
                    }, { once: true });
                };

                const onOutsideClick = (e) => {
                    if (e.target === modal) {
                        onCancel();
                    }
                };

                cancelBtn.addEventListener('click', onCancel);
                confirmBtn.addEventListener('click', onConfirm);
                closeBtn.addEventListener('click', onCancel);
                modal.addEventListener('click', onOutsideClick);
            });
        }

        async function exportSelectedYears(selectedYears) {
            if (selectedYears.length === 0) {
                showNotification("Please select at least one year to export.", "warning");
                return;
            }

            showLoading(true);
            try {
                const processes = ['ma', 'ct', 'gmp'];
                const wb = XLSX.utils.book_new();

                for (const process of processes) {
                    let data = fullDatasetCache[process];
                    if (!data) {
                        const response = await fetch(`${API_BASE_URL}/${process}`, {
                            headers: { 'Authorization': AUTH_CREDENTIALS }
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        data = await response.json();
                        fullDatasetCache[process] = data;
                    }

                    const filteredData = data.filter(item => {
                        const year = extractYearFromQuarter(item.quarter);
                        return selectedYears.includes(year);
                    });

                    if (filteredData.length === 0) continue;

                    filteredData.sort((a, b) => {
                        const yearA = extractYearFromQuarter(a.quarter);
                        const qtrA = parseInt(a.quarter.substring(a.quarter.indexOf('Q') + 1));
                        const yearB = extractYearFromQuarter(b.quarter);
                        const qtrB = parseInt(b.quarter.substring(b.quarter.indexOf('Q') + 1));

                        if (yearA !== yearB) return yearA - yearB;
                        return qtrA - qtrB;
                    });

                    const wsData = filteredData.map(item => {
                        const row = { Quarter: formatQuarterDisplay(item.quarter) };
                        Object.keys(item)
                            .filter(key => !['id', 'quarter', 'run_date', 'year'].includes(key) && kpiNameMap[key])
                            .forEach(key => {
                                row[kpiNameMap[key] || key] = formatValue(key, item[key]);
                            });
                        return row;
                    });

                    const ws = XLSX.utils.json_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, process.toUpperCase());
                }

                if (wb.SheetNames.length === 0) {
                    showNotification("No data available to export for selected years.", "warning");
                    return;
                }

                const yearRange = selectedYears.length === 1 ? selectedYears[0] :
                                `${Math.min(...selectedYears)}-${Math.max(...selectedYears)}`;
                XLSX.writeFile(wb, `kpi_data_${yearRange}.xlsx`);
                showNotification(`KPI data for selected years exported successfully!`, "success");

            } catch (error) {
                console.error("Error exporting data:", error);
                showNotification("Failed to export data for selected years.", "error");
            } finally {
                showLoading(false);
            }
        }

        async function exportAllData() {
            showLoading(true);
            try {
                const processes = ['ma', 'ct', 'gmp'];
                const wb = XLSX.utils.book_new();

                for (const process of processes) {
                    let data = fullDatasetCache[process];
                    if (!data) {
                        const response = await fetch(`${API_BASE_URL}/${process}`, {
                            headers: { 'Authorization': AUTH_CREDENTIALS }
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        data = await response.json();
                        fullDatasetCache[process] = data;
                    }

                    if (data.length === 0) continue;

                    data.sort((a, b) => {
                        const yearA = extractYearFromQuarter(a.quarter);
                        const qtrA = parseInt(a.quarter.substring(a.quarter.indexOf('Q') + 1));
                        const yearB = extractYearFromQuarter(b.quarter);
                        const qtrB = parseInt(b.quarter.substring(b.quarter.indexOf('Q') + 1));

                        if (yearA !== yearB) return yearA - yearB;
                        return qtrA - qtrB;
                    });

                    const wsData = data.map(item => {
                        const row = { Quarter: formatQuarterDisplay(item.quarter) };
                        Object.keys(item)
                            .filter(key => !['id', 'quarter', 'run_date', 'year'].includes(key) && kpiNameMap[key])
                            .forEach(key => {
                                row[kpiNameMap[key] || key] = formatValue(key, item[key]);
                            });
                        return row;
                    });

                    const ws = XLSX.utils.json_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, process.toUpperCase());
                }

                if (wb.SheetNames.length === 0) {
                    showNotification("No data available to export.", "warning");
                    return;
                }

                XLSX.writeFile(wb, `kpi_data_all_years.xlsx`);
                showNotification("All KPI data exported successfully!", "success");

            } catch (error) {
                console.error("Error exporting all data:", error);
                showNotification("Failed to export all data.", "error");
            } finally {
                showLoading(false);
            }
        }

        async function fetchInitialDataAndPopulateFilters() {
            showLoading(true);
            try {
                const processes = ['ma', 'ct', 'gmp'];
                for (const process of processes) {
                    const response = await fetch(`${API_BASE_URL}/${process}`, {
                        headers: { 'Authorization': AUTH_CREDENTIALS }
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    console.log(`Initial data for ${process}:`, data);
                    fullDatasetCache[process] = data;
                }
                populateYearFilter();
            } catch (error) {
                console.error("Error fetching initial data:", error);
                showNotification("Failed to fetch initial data for filters.", "error");
            } finally {
                showLoading(false);
            }
        }

        function setupEventListeners() {
            document.getElementById('enter-dashboard-btn').addEventListener('click', function() {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('dashboard-page').classList.remove('hidden');
                const year = document.getElementById('year-filter').value;
                const quarter = document.getElementById('quarter-filter').value;
                const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                if (year && activeTab) {
                    loadKPIs(activeTab, year, quarter);
                }
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const tab = this.getAttribute('data-tab');
                    const year = document.getElementById('year-filter').value;
                    const quarter = document.getElementById('quarter-filter').value;

                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.classList.remove('active', 'scale-105', 'bg-[#00A65A]', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
                    });
                    this.classList.add('active', 'scale-105', 'bg-[#00A65A]', 'text-white');
                    this.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
                    setTimeout(() => this.classList.remove('scale-105'), 300);

                    document.querySelectorAll('.tab-content').forEach(c => {
                        c.classList.add('hidden');
                        c.classList.remove('animate-fadeIn');
                    });

                    const activeTabContent = document.getElementById(`${tab}-tab`);
                    activeTabContent.classList.remove('hidden');
                    activeTabContent.classList.add('animate-fadeIn');

                    if (year) await loadKPIs(tab, year, quarter);
                });
            });

            document.getElementById('year-filter').addEventListener('change', async function() {
                const year = this.value;
                const quarter = document.getElementById('quarter-filter').value;
                const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                if (year) await loadKPIs(activeTab, year, quarter);
            });

            document.getElementById('quarter-filter').addEventListener('change', async function() {
                const quarter = this.value;
                const year = document.getElementById('year-filter').value;
                const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                if (year) await loadKPIs(activeTab, year, quarter);
            });

            document.addEventListener('click', function(e) {
                const cell = e.target.closest('.trend-cell');
                if (cell) {
                    const kpiName = cell.getAttribute('data-kpi');
                    const process = cell.getAttribute('data-process');
                    showTrendChart(kpiName, process);
                }
            });

            document.getElementById('close-trend-modal').addEventListener('click', function() {
                const modal = document.getElementById('trend-modal');
                document.querySelector('#trend-modal .modal-content').classList.add('scale-95', 'opacity-0');
                document.querySelector('#trend-modal .modal-content').classList.remove('scale-100', 'opacity-100');
                modal.addEventListener('transitionend', function handler() {
                    modal.classList.add('hidden');
                    modal.removeEventListener('transitionend', handler);
                    if (kpiTrendChartInstance) {
                        kpiTrendChartInstance.destroy();
                        kpiTrendChartInstance = null;
                    }
                }, { once: true });
            });

            document.getElementById('trend-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    document.querySelector('#trend-modal .modal-content').classList.add('scale-95', 'opacity-0');
                    document.querySelector('#trend-modal .modal-content').classList.remove('scale-100', 'opacity-100');
                    this.addEventListener('transitionend', function handler() {
                        this.classList.add('hidden');
                        this.removeEventListener('transitionend', handler);
                        if (kpiTrendChartInstance) {
                            kpiTrendChartInstance.destroy();
                            kpiTrendChartInstance = null;
                        }
                    }, { once: true });
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !document.getElementById('trend-modal').classList.contains('hidden')) {
                    const modal = document.getElementById('trend-modal');
                    document.querySelector('#trend-modal .modal-content').classList.add('scale-95', 'resize-y');
                    document.querySelector('#trend-modal .modal-content').classList.remove('scale-100', 'opacity-100');
                    modal.addEventListener('transitionend', function handler() {
                        modal.classList.add('hidden');
                        modal.removeEventListener('transitionend', handler);
                        if (kpiTrendChartInstance) {
                            kpiTrendChartInstance.destroy();
                            kpiTrendChartInstance = null;
                        }
                    }, { once: true });
                }
            });

            const exportBtn = document.getElementById('export-btn');
            const exportDropdown = document.getElementById('export-dropdown');
            exportBtn.addEventListener('click', function() {
                exportDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', function(event) {
                if (!exportBtn.contains(event.target) && !exportDropdown.contains(event.target)) {
                    exportDropdown.classList.add('hidden');
                }
            });

            document.getElementById('export-selected-btn').addEventListener('click', async function() {
                exportDropdown.classList.add('hidden');
                const selectedYears = await showExportModal();
                if (selectedYears && selectedYears.length > 0) {
                    await exportSelectedYears(selectedYears);
                }
            });

            document.getElementById('export-all-btn').addEventListener('click', function() {
                exportDropdown.classList.add('hidden');
                exportAllData();
            });
        }

        async function initDashboard() {
            Object.keys(fullDatasetCache).forEach(key => delete fullDatasetCache[key]); // Clear cache
            await fetchInitialDataAndPopulateFilters();
            setupEventListeners();

            const initialActiveTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
            const initialYear = document.getElementById('year-filter').value;
            const initialQuarter = document.getElementById('quarter-filter').value;

            if (initialActiveTab && initialYear) {
                loadKPIs(initialActiveTab, initialYear, initialQuarter);
            }
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
