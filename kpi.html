<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic KPI Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Tailwind Configuration (optional, if you want to extend/override) */
        :root {
            --color-primary-green: #2E7D32;
            --color-warning-orange: #F59E0B;
            --color-critical-red: #DC2626;
            --color-accent-blue: #3B82F6;
            --color-bg-light: #f8fafc; /* slate-50 */
            --color-bg-card-light: #ffffff;
            --color-text-light: #1e293b; /* slate-800 */
            --color-border-light: #e2e8f0; /* slate-200 */

            --color-bg-dark: #1a202c; /* gray-900 */
            --color-bg-card-dark: #2d3748; /* gray-800 */
            --color-text-dark: #e2e8f0; /* gray-200 */
            --color-border-dark: #4a5568; /* gray-700 */
        }

        .light {
            background-color: var(--color-bg-light);
            color: var(--color-text-light);
        }
        .dark {
            background-color: var(--color-bg-dark);
            color: var(--color-text-dark);
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-border-light);
            border-radius: 10px;
        }
        .dark::-webkit-scrollbar-track {
            background: var(--color-border-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .card {
            background-color: var(--color-bg-card-light);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            border: 1px solid var(--color-border-light);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .dark .card {
            background-color: var(--color-bg-card-dark);
            border-color: var(--color-border-dark);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .tab-btn {
            @apply px-6 py-3 text-lg font-semibold rounded-t-lg transition-all duration-300 ease-in-out;
            color: var(--color-text-light);
            background-color: var(--color-bg-card-light);
            border-bottom: 3px solid transparent;
        }
        .dark .tab-btn {
            color: var(--color-text-dark);
            background-color: var(--color-bg-card-dark);
        }
        .tab-btn.active {
            @apply text-white;
            background-color: var(--color-accent-blue);
            border-color: var(--color-accent-blue);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .status-badge {
            @apply inline-flex items-center px-3 py-1 text-xs font-medium rounded-full;
        }
        .status-good { @apply bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100; }
        .status-warning { @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100; }
        .status-critical { @apply bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100; }

        .kpi-cell {
            @apply px-6 py-4 border-b border-gray-200 dark:border-gray-700 text-sm;
        }
        .kpi-name-cell {
            @apply font-medium text-gray-900 dark:text-gray-100;
        }
        .kpi-number {
            @apply mr-2 font-bold text-gray-500 dark:text-gray-400;
        }
        .value-cell.good { @apply text-green-600 dark:text-green-400 font-bold; }
        .value-cell.warning { @apply text-yellow-600 dark:text-yellow-400 font-bold; }
        .value-cell.critical { @apply text-red-600 dark:text-red-400 font-bold; }
        
        /* Animation for tab content */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--color-accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .dark .spinner {
            border-color: rgba(255, 255, 255, 0.2);
            border-left-color: var(--color-accent-blue);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--color-bg-card-light);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--color-border-light);
        }
        .dark .modal-content {
            background-color: var(--color-bg-card-dark);
            border-color: var(--color-border-dark);
        }
    </style>
</head>
<body class="min-h-screen antialiased transition-colors duration-300">

    <div id="landing-page" class="flex flex-col items-center justify-center min-h-screen text-center p-6">
        <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 dark:text-white mb-6 animate-pulse">
            <span class="text-indigo-600 dark:text-indigo-400">KPI</span> Performance Dashboard
        </h1>
        <p class="text-lg md:text-xl text-gray-700 dark:text-gray-300 max-w-2xl mb-10">
            Gain real-time insights into your key performance indicators across different processes.
            Monitor trends, identify critical areas, and track year-over-year changes to drive better decisions.
        </p>
        <button id="enter-dashboard-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition-all duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
            Enter Dashboard
            <svg class="inline-block ml-2 -mr-1 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
        </button>
    </div>

    <div id="dashboard-page" class="min-h-screen hidden p-4 sm:p-6 lg:p-8">
        <header class="flex flex-col sm:flex-row items-center justify-between py-4 border-b border-gray-200 dark:border-gray-700 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4 sm:mb-0">
                Performance Overview
            </h1>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <select id="year-filter" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <svg id="theme-icon-light" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M3 12H2m8.006-8.327l-.707-.707m-5.657 5.657l-.707-.707m-2.122 2.121l-.707.707m5.657 5.657l-.707.707M19 12a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <svg id="theme-icon-dark" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <section class="lg:col-span-2 flex flex-col">
                <div class="flex flex-wrap border-b border-gray-200 dark:border-gray-700 mb-4">
                    <button class="tab-btn active" data-tab="ma">Market Access</button>
                    <button class="tab-btn" data-tab="ct">Clinical Trials</button>
                    <button class="tab-btn" data-tab="gmp">GMP Compliance</button>
                </div>

                <div id="ma-tab" class="tab-content animate-fadeIn flex-grow flex flex-col">
                    <div class="card p-6 overflow-hidden flex-grow flex flex-col">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">Market Access KPIs</h2>
                        <div class="overflow-x-auto flex-grow">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">KPI</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Latest Quarter</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Value</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="ma-kpi-table" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="ct-tab" class="tab-content hidden animate-fadeIn flex-grow flex flex-col">
                    <div class="card p-6 overflow-hidden flex-grow flex flex-col">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">Clinical Trials KPIs</h2>
                        <div class="overflow-x-auto flex-grow">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">KPI</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Latest Quarter</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Value</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="ct-kpi-table" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="gmp-tab" class="tab-content hidden animate-fadeIn flex-grow flex flex-col">
                    <div class="card p-6 overflow-hidden flex-grow flex flex-col">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">GMP Compliance KPIs</h2>
                        <div class="overflow-x-auto flex-grow">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">KPI</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Latest Quarter</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Value</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="gmp-kpi-table" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <aside class="lg:col-span-1 flex flex-col space-y-6">
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">KPI Status Summary</h2>
                    <div class="grid grid-cols-3 gap-4 text-center mb-6">
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-extrabold text-green-600 dark:text-green-400" id="kpi-status-good">0</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">On Target</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-extrabold text-yellow-600 dark:text-yellow-400" id="kpi-status-warning">0</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">Needs Attention</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-extrabold text-red-600 dark:text-red-400" id="kpi-status-critical">0</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">Below Target</span>
                        </div>
                    </div>
                    <div class="chart-container h-48 mb-6">
                        <canvas id="status-chart"></canvas>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2">Critical Alerts:</h3>
                    <div id="critical-alerts" class="text-sm text-gray-700 dark:text-gray-300 space-y-2 max-h-32 overflow-y-auto custom-scrollbar">
                        <p class="text-gray-500 dark:text-gray-400">No critical alerts</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Year-over-Year Comparison</h2>
                    <div class="grid grid-cols-2 gap-4 text-center mb-6">
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-extrabold text-green-600 dark:text-green-400" id="yoy-improved">0</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">Improved KPIs</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-4xl font-extrabold text-red-600 dark:text-red-400" id="yoy-declined">0</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">Declined KPIs</span>
                        </div>
                    </div>
                    <div class="chart-container h-48 mb-6">
                        <canvas id="yoy-chart"></canvas>
                    </div>
                    <div class="text-center text-lg font-semibold text-gray-800 dark:text-gray-100">
                        Total KPIs Monitored: <span id="total-kpis" class="text-indigo-600 dark:text-indigo-400">0</span>
                    </div>
                    <div class="text-center text-xl font-bold mt-4 text-gray-800 dark:text-gray-100">
                        Overall Compliance Rate: <span id="compliance-rate" class="text-indigo-600 dark:text-indigo-400">0.0%</span>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Export Data</h2>
                    <div class="flex flex-col space-y-3">
                        <button id="export-selected-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow transition-colors duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l3-3m-3 3l-3-3m-3 8h12a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Export Selected Year
                        </button>
                        <button id="export-all-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md shadow transition-colors duration-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export All Data
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <div id="trend-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="modal-content relative w-full max-w-4xl mx-auto rounded-xl p-6 shadow-lg transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">KPI Trend (Full Period)</h2>
            <button id="close-trend-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="chart-container w-full h-80">
                <canvas id="trend-chart"></canvas>
            </div>
        </div>
    </div>

    <div id="loading-spinner" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 z-[60] flex items-center justify-center hidden transition-opacity duration-300">
        <div class="spinner"></div>
    </div>

    <div id="notification-container" class="fixed top-4 right-4 z-[70] space-y-2">
        </div>

    <script>
        // API Base URL (replace with your actual API endpoint if different)
        const API_BASE_URL = 'http://localhost:3000/kpis';

        // Cache for full dataset to avoid re-fetching on tab/year changes
        const fullDatasetCache = {};

        // Chart instances holder to manage chart destruction/creation
        const chartInstances = {};

        // Map for display names of KPIs
        const kpiNameMap = {
            "processing_time": "Average Processing Time (days)",
            "approval_rate_pct": "Approval Rate (%)",
            "error_rate_pct": "Error Rate (%)",
            "customer_satisfaction_score": "Customer Satisfaction Score",
            "cost_per_unit": "Cost Per Unit ($)",
            "on_time_delivery_pct": "On-Time Delivery (%)",
            "resource_utilization_pct": "Resource Utilization (%)",
            "cycle_time_days": "Average Cycle Time (Days)",
            "pass_rate_pct": "Pass Rate (%)",
            "audit_findings_per_batch": "Audit Findings Per Batch",
            "training_completion_pct": "Training Completion (%)",
            "change_control_closure_time_days": "Change Control Closure Time (Days)",
            "deviation_rate_pct": "Deviation Rate (%)",
            "pct_gcp_compliant": "GCP Compliance (%)",
            "enrollment_rate": "Enrollment Rate",
            "data_query_resolution_time_days": "Data Query Resolution Time (Days)",
            "adverse_event_reporting_time_days": "Adverse Event Reporting Time (Days)",
            "site_initiation_time_days": "Site Initiation Time (Days)",
            "pct_facilities_compliant": "Facilities Compliance (%)",
            "batch_release_time_days": "Batch Release Time (Days)",
            "yield_rate_pct": "Yield Rate (%)",
            "inspection_readiness_score": "Inspection Readiness Score",
            "equipment_downtime_pct": "Equipment Downtime (%)",
            "qc_reject_rate_pct": "QC Reject Rate (%)",
            "pct_granted_within_90_days": "Granted within 90 Days (%)"
        };

        // Target ranges for KPI status (min, target, max)
        // These are examples; adjust based on actual business rules
        const kpiTargets = {
            "processing_time": { type: 'lower_is_better', good: 30, warning: 45 }, // days
            "approval_rate_pct": { type: 'higher_is_better', good: 90, warning: 80 }, // %
            "error_rate_pct": { type: 'lower_is_better', good: 2, warning: 5 }, // %
            "customer_satisfaction_score": { type: 'higher_is_better', good: 4.5, warning: 3.5 }, // score out of 5
            "cost_per_unit": { type: 'lower_is_better', good: 10, warning: 15 }, // $
            "on_time_delivery_pct": { type: 'higher_is_better', good: 95, warning: 90 }, // %
            "resource_utilization_pct": { type: 'higher_is_better', good: 80, warning: 70 }, // %
            "cycle_time_days": { type: 'lower_is_better', good: 60, warning: 90 }, // days
            "pass_rate_pct": { type: 'higher_is_better', good: 98, warning: 95 }, // %
            "audit_findings_per_batch": { type: 'lower_is_better', good: 0.5, warning: 1.5 }, // count
            "training_completion_pct": { type: 'higher_is_better', good: 95, warning: 85 }, // %
            "change_control_closure_time_days": { type: 'lower_is_better', good: 15, warning: 30 }, // days
            "deviation_rate_pct": { type: 'lower_is_better', good: 1, warning: 3 }, // %
            "pct_gcp_compliant": { type: 'higher_is_better', good: 98, warning: 90 }, // %
            "enrollment_rate": { type: 'higher_is_better', good: 80, warning: 60 }, // %
            "data_query_resolution_time_days": { type: 'lower_is_better', good: 7, warning: 14 }, // days
            "adverse_event_reporting_time_days": { type: 'lower_is_better', good: 1, warning: 3 }, // days
            "site_initiation_time_days": { type: 'lower_is_better', good: 90, warning: 120 }, // days
            "pct_facilities_compliant": { type: 'higher_is_better', good: 95, warning: 85 }, // %
            "batch_release_time_days": { type: 'lower_is_better', good: 7, warning: 14 }, // days
            "yield_rate_pct": { type: 'higher_is_better', good: 99, warning: 95 }, // %
            "inspection_readiness_score": { type: 'higher_is_better', good: 4, warning: 3 }, // score out of 5
            "equipment_downtime_pct": { type: 'lower_is_better', good: 5, warning: 10 }, // %
            "qc_reject_rate_pct": { type: 'lower_is_better', good: 1, warning: 3 }, // %
            "pct_granted_within_90_days": { type: 'higher_is_better', good: 90, warning: 80 } // %
        };

        // Helper functions
        function showLoading(isLoading) {
            document.getElementById('loading-spinner').classList.toggle('hidden', !isLoading);
            document.getElementById('loading-spinner').classList.toggle('opacity-0', !isLoading);
            document.getElementById('loading-spinner').classList.toggle('opacity-100', isLoading);
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `p-4 rounded-lg shadow-lg text-white font-medium mb-2 transition-all duration-300 transform translate-x-full opacity-0`;

            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            else if (type === 'error') bgColor = 'bg-red-500';
            else if (type === 'warning') bgColor = 'bg-yellow-500';

            notification.classList.add(bgColor);
            notification.innerHTML = `
                <div class="flex items-center">
                    ${type === 'success' ? '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
                    ${type === 'error' ? '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2A9 9 0 111 12a9 9 0 0118 0z"></path></svg>' : ''}
                    ${type === 'warning' ? '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>' : ''}
                    <span>${message}</span>
                </div>
            `;
            container.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
                notification.classList.add('translate-x-0', 'opacity-100');
            }, 50); // Small delay to trigger transition

            setTimeout(() => {
                notification.classList.remove('translate-x-0', 'opacity-100');
                notification.classList.add('translate-x-full', 'opacity-0');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 5000); // Notification disappears after 5 seconds
        }

        function formatQuarterDisplay(quarter) {
            if (!quarter) return 'N/A';
            // Assuming quarter format is "YYYY-QX"
            const [year, qNum] = quarter.split('-');
            return `${qNum} ${year}`;
        }

        function extractYearFromQuarter(quarter) {
            if (!quarter) return null;
            return parseInt(quarter.split('-')[0]);
        }

        function formatValue(kpiName, value) {
            if (value === null || value === undefined) return 'N/A';
            if (kpiName.includes('pct')) {
                return `${value.toFixed(1)}%`;
            } else if (kpiName.includes('cost')) {
                return `$${value.toFixed(2)}`;
            } else if (kpiName.includes('time') || kpiName.includes('days')) {
                return `${value.toFixed(0)} days`;
            } else if (kpiName.includes('score')) {
                return `${value.toFixed(1)}/5`;
            }
            return value.toFixed(1);
        }

        function determineStatus(kpiName, value) {
            const target = kpiTargets[kpiName];
            if (value === null || value === undefined || !target) return 'unknown';

            if (target.type === 'higher_is_better') {
                if (value >= target.good) return 'good';
                if (value >= target.warning) return 'warning';
                return 'critical';
            } else if (target.type === 'lower_is_better') {
                if (value <= target.good) return 'good';
                if (value <= target.warning) return 'warning';
                return 'critical';
            }
            return 'unknown';
        }

        function getStatusText(status) {
            switch (status) {
                case 'good': return 'On Target';
                case 'warning': return 'Needs Attention';
                case 'critical': return 'Below Target';
                default: return 'Unknown';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'good': return 'status-good';
                case 'warning': return 'status-warning';
                case 'critical': return 'status-critical';
                default: return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
            }
        }

        // Initialize dashboard state and load initial data
        async function initDashboard() {
            populateYearFilter();
            setupThemeToggle(); // Setup theme toggle immediately
            setupEventListeners(); // Setup general event listeners

            // Only load data if already on dashboard page (e.g., after refresh)
            // Or if user clicks "Enter Dashboard" button later.
            // For initial load, landing page is shown.
            if (!document.getElementById('dashboard-page').classList.contains('hidden')) {
                const year = document.getElementById('year-filter').value;
                const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                if (year && activeTab) {
                    await loadKPIs(activeTab, year);
                }
            }
        }

        // Populate year filter dropdown
        function populateYearFilter() {
            const yearFilter = document.getElementById('year-filter');
            const currentYear = new Date().getFullYear();
            const startYear = 2018; // Adjust as needed for your data
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            }
            // Set current year as default or the latest available in your data
            yearFilter.value = currentYear;
        }

        // Create mini trend chart for table cells
        function createMiniChart(elementId, data, labels) {
            const canvas = document.getElementById(elementId);
            if (!canvas) {
                console.error(`Canvas element with ID '${elementId}' not found.`);
                return;
            }

            const ctx = canvas.getContext('2d');
            const dpi = window.devicePixelRatio || 1;

            // Adjust canvas resolution for high DPI screens
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.width = canvas.offsetWidth * dpi;
            canvas.height = canvas.offsetHeight * dpi;

            // Filter out null/undefined values for charting
            const filteredData = data.map(value => (value === null || value === undefined) ? NaN : value);

            // Destroy existing chart if it exists
            if (chartInstances[elementId]) {
                chartInstances[elementId].destroy();
            }

            chartInstances[elementId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: filteredData,
                        borderColor: '#A78BFA', // A soft purple for mini-trends
                        borderWidth: 1.5 * dpi,
                        backgroundColor: 'rgba(167, 139, 250, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0, // No points on mini chart
                        pointHitRadius: 8 * dpi, // Larger hit area for hover
                        segment: {
                            borderColor: ctx => {
                                // Dynamic color based on change (if values are comparable)
                                const prev = ctx.p0.parsed.y;
                                const curr = ctx.p1.parsed.y;
                                if (isNaN(prev) || isNaN(curr)) return '#A78BFA'; // Default for initial or missing data

                                const kpiName = elementId.split('-')[2]; // Extract kpi name from ID
                                const target = kpiTargets[kpiName];
                                if (!target) return '#A78BFA';

                                if (target.type === 'lower_is_better') {
                                    return curr <= prev ? var_color_primary_green : var_color_critical_red;
                                } else { // higher_is_better
                                    return curr >= prev ? var_color_primary_green : var_color_critical_red;
                                }
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false // Disable tooltips for mini charts
                        }
                    },
                    scales: {
                        x: {
                            display: false, // Hide x-axis
                            grid: { display: false }
                        },
                        y: {
                            display: false, // Hide y-axis
                            grid: { display: false }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Show full trend chart in a modal
        async function showTrendChart(kpiName, process) {
            showLoading(true);

            try {
                let kpis = fullDatasetCache[process];

                if (!kpis) {
                    const response = await fetch(`${API_BASE_URL}/${process}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    kpis = await response.json();
                    fullDatasetCache[process] = kpis;
                }

                // Filter out null/undefined KPI values for trend analysis
                const filteredKpis = kpis.filter(kpi => kpi[kpiName] !== null && kpi[kpiName] !== undefined);
                const sortedKpis = [...filteredKpis].sort((a, b) => a.quarter.localeCompare(b.quarter));

                if (sortedKpis.length === 0) {
                    showNotification("No trend data available for this KPI.", "warning");
                    showLoading(false);
                    return;
                }

                const quarters = sortedKpis.map(kpi => formatQuarterDisplay(kpi.quarter));
                const values = sortedKpis.map(kpi => kpi[kpiName]);

                document.getElementById('modal-title').textContent = `${kpiNameMap[kpiName] || kpiName} Trend (Full Period)`;

                const ctx = document.getElementById('trend-chart').getContext('2d');

                const dpi = window.devicePixelRatio || 1;
                const chartContainer = document.querySelector('#trend-modal .chart-container');
                
                // Adjust canvas size for high DPI
                ctx.canvas.style.width = '100%';
                ctx.canvas.style.height = '100%';
                ctx.canvas.width = chartContainer.offsetWidth * dpi;
                ctx.canvas.height = chartContainer.offsetHeight * dpi;

                if (chartInstances.trendChart) {
                    chartInstances.trendChart.destroy();
                }

                chartInstances.trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: quarters,
                        datasets: [{
                            label: kpiNameMap[kpiName] || kpiName,
                            data: values,
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32',
                            borderWidth: 3 * dpi,
                            backgroundColor: 'rgba(46, 125, 50, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4 * dpi,
                            pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32',
                            pointHoverRadius: 6 * dpi,
                            segment: {
                                borderColor: ctx => {
                                    const prev = ctx.p0.parsed.y;
                                    const curr = ctx.p1.parsed.y;
                                    if (isNaN(prev) || isNaN(curr)) return getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32';

                                    const target = kpiTargets[kpiName];
                                    if (!target) return getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32';

                                    if (target.type === 'lower_is_better') {
                                        return curr <= prev ? getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32' : getComputedStyle(document.documentElement).getPropertyValue('--color-critical-red') || '#DC2626';
                                    } else { // higher_is_better
                                        return curr >= prev ? getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32' : getComputedStyle(document.documentElement).getPropertyValue('--color-critical-red') || '#DC2626';
                                    }
                                }
                            }
                        }]
                    },
                    plugins: [{
                        id: 'trendline',
                        afterDraw: function(chart) {
                            // Only draw trendline if there's enough data and it makes sense
                            if (values.length > 3 && values.every(v => !isNaN(v))) {
                                const ctx = chart.ctx;
                                const dataset = chart.data.datasets[0];
                                const xAxis = chart.scales.x;
                                const yAxis = chart.scales.y;

                                // Calculate linear regression trend line
                                let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                                const n = dataset.data.length;

                                dataset.data.forEach((value, index) => {
                                    sumX += index;
                                    sumY += value;
                                    sumXY += index * value;
                                    sumXX += index * index;
                                });

                                const denominator = (n * sumXX - sumX * sumX);
                                if (denominator === 0) return; // Avoid division by zero if all x values are the same (unlikely for index)

                                const slope = (n * sumXY - sumX * sumY) / denominator;
                                const intercept = (sumY - slope * sumX) / n;

                                // Draw trend line
                                ctx.beginPath();
                                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-accent-blue') || '#3B82F6';
                                ctx.lineWidth = 2 * dpi;
                                ctx.setLineDash([5 * dpi, 3 * dpi]); // Dashed line

                                const firstX = xAxis.getPixelForValue(0);
                                const lastX = xAxis.getPixelForValue(n - 1);
                                const firstY = yAxis.getPixelForValue(intercept);
                                const lastY = yAxis.getPixelForValue(slope * (n - 1) + intercept);

                                ctx.moveTo(firstX, firstY);
                                ctx.lineTo(lastX, lastY);
                                ctx.stroke();
                                ctx.setLineDash([]); // Reset line dash

                                // Add trend label if meaningful
                                if (intercept !== 0 && !isNaN(slope) && !isNaN(intercept)) { // Ensure values are not NaN
                                    const initialValue = intercept; // Value at the beginning of the trend line
                                    const finalValue = slope * (n - 1) + intercept; // Value at the end of the trend line
                                    
                                    let trendValue = 0;
                                    if (initialValue !== 0) {
                                        trendValue = ((finalValue - initialValue) / Math.abs(initialValue)) * 100;
                                    }
                                    
                                    const trendText = `Overall Trend: ${trendValue.toFixed(1)}% ${trendValue >= 0 ? '↑' : '↓'}`;
                                    
                                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-accent-blue') || '#3B82F6';
                                    ctx.font = `bold ${12 * dpi}px Inter`;
                                    ctx.textAlign = 'right';
                                    // Position text slightly above and to the right of the last point of the trend line
                                    ctx.fillText(trendText, lastX - (10 * dpi), lastY - (10 * dpi));
                                }
                            }
                        }
                    }],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14 * dpi,
                                        weight: 'bold',
                                        family: 'Inter'
                                    },
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-light') // Dynamic text color
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                bodyFont: {
                                    size: 14 * dpi,
                                    weight: 'bold',
                                    family: 'Inter'
                                },
                                titleFont: {
                                    size: 12 * dpi,
                                    family: 'Inter'
                                },
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += formatValue(kpiName, context.parsed.y);
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false,
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-border-light') // Dynamic grid color
                                },
                                ticks: {
                                    font: {
                                        size: 12 * dpi,
                                        family: 'Inter'
                                    },
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-light') // Dynamic text color
                                }
                            },
                            y: {
                                beginAtZero: kpiName.includes('pct') || kpiName.includes('score') ? true : false, // Start at 0 for percentages/scores
                                grid: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-border-light') // Dynamic grid color
                                },
                                ticks: {
                                    font: {
                                        size: 12 * dpi,
                                        family: 'Inter'
                                    },
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-light'), // Dynamic text color
                                    callback: function(value) {
                                        return formatValue(kpiName, value);
                                    }
                                }
                            }
                        }
                    }
                });

                document.getElementById('trend-modal').classList.remove('hidden');
                // Animate modal entry
                setTimeout(() => {
                    document.querySelector('#trend-modal .modal-content').classList.remove('scale-95', 'opacity-0');
                    document.querySelector('#trend-modal .modal-content').classList.add('scale-100', 'opacity-100');
                }, 50);

            } catch (error) {
                console.error("Failed to load trend data:", error);
                showNotification("Failed to load trend data. Please check console for details.", "error");
            } finally {
                showLoading(false);
            }
        }

        // Update status chart (Doughnut)
        function updateStatusChart(good, warning, critical) {
            const ctx = document.getElementById('status-chart').getContext('2d');

            const dpi = window.devicePixelRatio || 1;
            ctx.canvas.style.width = '100%';
            ctx.canvas.style.height = '100%';
            ctx.canvas.width = ctx.canvas.offsetWidth * dpi;
            ctx.canvas.height = ctx.canvas.offsetHeight * dpi;

            if (chartInstances.statusChart) {
                chartInstances.statusChart.destroy();
            }

            chartInstances.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['On Target', 'Needs Attention', 'Below Target'],
                    datasets: [{
                        data: [good, warning, critical],
                        backgroundColor: [
                            getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32',
                            getComputedStyle(document.documentElement).getPropertyValue('--color-warning-orange') || '#F59E0B',
                            getComputedStyle(document.documentElement).getPropertyValue('--color-critical-red') || '#DC2626'
                        ],
                        borderWidth: 1 * dpi,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-bg-card-light') // Matches card background
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12 * dpi,
                                    family: 'Inter'
                                },
                                color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-light')
                            }
                        },
                        tooltip: {
                            bodyFont: {
                                size: 14 * dpi,
                                weight: 'bold',
                                family: 'Inter'
                            },
                            titleFont: {
                                size: 12 * dpi,
                                family: 'Inter'
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed + ' KPIs';
                                    return label;
                                }
                            }
                        }
                    },
                    cutout: '70%', // Make it a thinner doughnut
                }
            });
        }

        // Update YoY chart (Bar)
        function updateYoYChart(improved, declined) {
            const ctx = document.getElementById('yoy-chart').getContext('2d');

            const dpi = window.devicePixelRatio || 1;
            ctx.canvas.style.width = '100%';
            ctx.canvas.style.height = '100%';
            ctx.canvas.width = ctx.canvas.offsetWidth * dpi;
            ctx.canvas.height = ctx.canvas.offsetHeight * dpi;

            if (chartInstances.yoyChart) {
                chartInstances.yoyChart.destroy();
            }

            chartInstances.yoyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Improved', 'Declined'],
                    datasets: [{
                        label: 'Year-over-Year Change',
                        data: [improved, declined],
                        backgroundColor: [
                            getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32',
                            getComputedStyle(document.documentElement).getPropertyValue('--color-critical-red') || '#DC2626'
                        ],
                        borderWidth: 1 * dpi,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-bg-card-light')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            bodyFont: {
                                size: 14 * dpi,
                                weight: 'bold',
                                family: 'Inter'
                            },
                            titleFont: {
                                size: 12 * dpi,
                                family: 'Inter'
                            },
                             callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y + ' KPIs';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false,
                                color: getComputedStyle(document.documentElement).getPropertyValue('--color-border-light')
                            },
                            ticks: {
                                font: {
                                    size: 12 * dpi,
                                    family: 'Inter'
                                },
                                color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-light')
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--color-border-light')
                            },
                            ticks: {
                                font: {
                                    size: 12 * dpi,
                                    family: 'Inter'
                                },
                                color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-light'),
                                callback: function(value) {
                                    if (value % 1 === 0) return value; // Only show whole numbers for KPI count
                                }
                            }
                        }
                    }
                }
            });
        }

        // Analyze KPI trend for critical alerts
        function analyzeKPITrend(process, kpiName, currentYear) {
            if (!fullDatasetCache[process]) return null;

            const sortedKpis = [...fullDatasetCache[process]].sort((a, b) => a.quarter.localeCompare(b.quarter));
            const kpiData = sortedKpis.filter(kpi => kpi[kpiName] !== null && kpi[kpiName] !== undefined);

            if (kpiData.length < 2) return null;

            // Check for no improvement or decline over last 4 quarters (if data exists)
            const lastFourQuarters = kpiData.slice(-4);
            let noImprovementCount = 0; // for lower_is_better: value stayed same or increased; for higher_is_better: value stayed same or decreased
            let declineCount = 0; // for lower_is_better: value increased; for higher_is_better: value decreased

            const target = kpiTargets[kpiName];
            if (!target) return null;

            for (let i = 1; i < lastFourQuarters.length; i++) {
                const current = lastFourQuarters[i][kpiName];
                const previous = lastFourQuarters[i - 1][kpiName];

                if (current === null || previous === null || current === undefined || previous === undefined) continue;

                if (target.type === 'lower_is_better') {
                    // For time-based KPIs, lower is better
                    if (current >= previous) noImprovementCount++; // No improvement or decline
                    if (current > previous) declineCount++; // Actual decline
                } else {
                    // For percentage-based KPIs, higher is better
                    if (current <= previous) noImprovementCount++; // No improvement or decline
                    if (current < previous) declineCount++; // Actual decline
                }
            }

            // Check year-over-year decline for the latest full quarter in the current year
            let yoyDecline = null;
            const currentYearInt = parseInt(currentYear);

            const latestCurrentYearKpi = kpiData
                .filter(kpi => extractYearFromQuarter(kpi.quarter) === currentYearInt)
                .sort((a, b) => b.quarter.localeCompare(a.quarter))[0]; // Get the latest quarter for the current year

            if (latestCurrentYearKpi) {
                const latestQuarterYear = extractYearFromQuarter(latestCurrentYearKpi.quarter);
                const latestQuarterNum = parseInt(latestCurrentYearKpi.quarter.split('-Q')[1]);

                // Find the corresponding quarter in the previous year
                const prevYearQuarter = `${latestQuarterYear - 1}-Q${latestQuarterNum}`;
                const prevYearKpi = kpiData.find(kpi => kpi.quarter === prevYearQuarter);

                if (prevYearKpi && latestCurrentYearKpi[kpiName] !== null && prevYearKpi[kpiName] !== null) {
                    const currentVal = latestCurrentYearKpi[kpiName];
                    const prevVal = prevYearKpi[kpiName];

                    if (prevVal === 0 && currentVal === 0) {
                         yoyDecline = 0; // No change if both are zero
                    } else if (prevVal === 0 && currentVal !== 0) {
                        yoyDecline = 100; // Infinite increase, treat as significant positive change
                        if (target.type === 'lower_is_better') yoyDecline = -100; // Huge improvement if lower is better
                    } else if (prevVal !== 0) {
                        if (target.type === 'lower_is_better') {
                            yoyDecline = ((currentVal - prevVal) / prevVal) * 100; // Positive for increase (decline in performance)
                        } else { // higher_is_better
                            yoyDecline = ((prevVal - currentVal) / prevVal) * 100; // Positive for decrease (decline in performance)
                        }
                    }
                }
            }


            const latestData = kpiData[kpiData.length - 1];
            const latestQuarter = formatQuarterDisplay(latestData.quarter);
            const latestValue = formatValue(kpiName, latestData[kpiName]);

            // Generate alert message based on a combined threshold logic
            // Thresholds for alert generation:
            // - No improvement for 3+ quarters (value staying same or moving in undesired direction)
            // - Consistent decline for 3+ quarters (value moving in clearly undesired direction)
            // - Significant YoY decline (e.g., > 5% or 10% for continuous KPIs)

            let alertMessage = null;
            if (noImprovementCount >= 3) {
                alertMessage = `${kpiNameMap[kpiName] || kpiName} has shown no significant improvement over the last ${noImprovementCount} quarters. Latest value: ${latestValue} (${latestQuarter}).`;
            } else if (declineCount >= 3) {
                alertMessage = `${kpiNameMap[kpiName] || kpiName} has consistently declined over the last ${declineCount} quarters. Latest value: ${latestValue} (${latestQuarter}).`;
            } else if (yoyDecline !== null && yoyDecline > 5) { // Assuming a 5% YoY decline is significant
                alertMessage = `${kpiNameMap[kpiName] || kpiName} has declined by ${yoyDecline.toFixed(1)}% year-over-year. Latest value: ${latestValue} (${latestQuarter}).`;
            }

            if (alertMessage) {
                return {
                    name: kpiNameMap[kpiName] || kpiName,
                    message: alertMessage
                };
            }

            return null;
        }

        // Calculate KPI status summary
        function calculateKPIStatusSummary(kpis, process, year) {
            const summary = {
                good: 0,
                warning: 0,
                critical: 0,
                criticalAlerts: []
            };

            if (!kpis || kpis.length === 0) return summary;

            // Get unique KPI names from the first item, excluding metadata
            const kpiNames = Object.keys(kpis[0]).filter(
                key => !['id', 'quarter', 'run_date'].includes(key)
            );

            kpiNames.forEach(kpiName => {
                // Find the latest data point for this specific KPI
                const latestDataForKpi = kpis.reduce((latest, current) => {
                    // Ensure the current KPI value is not null/undefined before considering
                    if (current[kpiName] === null || current[kpiName] === undefined) {
                        return latest; // Skip this quarter if KPI data is missing
                    }
                    if (latest[kpiName] === null || latest[kpiName] === undefined) {
                         return current; // If latest is null, take current
                    }
                    return current.quarter > latest.quarter ? current : latest;
                }, { quarter: '', [kpiName]: null }); // Initialize with null KPI value

                if (latestDataForKpi[kpiName] === null) {
                    // console.warn(`Skipping KPI ${kpiName} for process ${process} as no valid latest data found.`);
                    return; // Skip if no valid data found for this KPI
                }

                const status = determineStatus(kpiName, latestDataForKpi[kpiName]);
                if (status === 'good') summary.good++;
                else if (status === 'warning') summary.warning++;
                else if (status === 'critical') {
                    summary.critical++;
                    const trendAnalysis = analyzeKPITrend(process, kpiName, year);
                    if (trendAnalysis) {
                        summary.criticalAlerts.push(trendAnalysis);
                    }
                }
            });

            return summary;
        }

        // Calculate year-over-year comparison
        async function calculateYoYComparison(process, year) {
            const prevYear = parseInt(year) - 1;
            const comparison = {
                improved: 0,
                declined: 0,
                totalKpis: 0
            };

            if (!fullDatasetCache[process]) return comparison;

            // Filter data for current and previous year
            const currentYearData = fullDatasetCache[process].filter(item => {
                return extractYearFromQuarter(item.quarter) === parseInt(year);
            });

            const prevYearData = fullDatasetCache[process].filter(item => {
                return extractYearFromQuarter(item.quarter) === prevYear;
            });

            if (!currentYearData.length || !prevYearData.length) {
                // console.warn(`Not enough data for YoY comparison for process ${process} for year ${year}.`);
                return comparison;
            }

            const kpiNames = Object.keys(currentYearData[0]).filter(
                key => !['id', 'quarter', 'run_date'].includes(key)
            );

            comparison.totalKpis = kpiNames.length;

            kpiNames.forEach(kpiName => {
                const currLatest = currentYearData.reduce((latest, curr) => {
                    return curr.quarter > latest.quarter ? curr : latest;
                }, { quarter: '', [kpiName]: null });

                const prevLatest = prevYearData.reduce((latest, curr) => {
                    return curr.quarter > latest.quarter ? curr : latest;
                }, { quarter: '', [kpiName]: null });

                if (currLatest[kpiName] !== null && prevLatest[kpiName] !== null) {
                    const target = kpiTargets[kpiName];
                    if (!target) return; // Skip if no target defined

                    const currentVal = currLatest[kpiName];
                    const prevVal = prevLatest[kpiName];

                    if (target.type === 'higher_is_better') {
                        if (currentVal > prevVal) comparison.improved++;
                        else if (currentVal < prevVal) comparison.declined++;
                    } else if (target.type === 'lower_is_better') {
                        if (currentVal < prevVal) comparison.improved++;
                        else if (currentVal > prevVal) comparison.declined++;
                    }
                }
            });

            return comparison;
        }

        // Calculate compliance rate
        function calculateComplianceRate(kpis, process) {
            const complianceKpisMap = {
                ma: 'pct_granted_within_90_days',
                ct: 'pct_gcp_compliant',
                gmp: 'pct_facilities_compliant'
            };

            const complianceKpiName = complianceKpisMap[process];
            if (!complianceKpiName) {
                // console.warn(`No compliance KPI defined for process: ${process}`);
                return 0;
            }

            if (!kpis || kpis.length === 0) return 0;

            // Find the latest quarter for the current year within the filtered `kpis` array
            const latestQuarterData = kpis.reduce((latest, current) => {
                if (!latest || current.quarter > latest.quarter) {
                    return current;
                }
                return latest;
            }, null);
            
            if (latestQuarterData && latestQuarterData[complianceKpiName] !== null && latestQuarterData[complianceKpiName] !== undefined) {
                return latestQuarterData[complianceKpiName];
            }

            return 0; // Return 0 if compliance KPI data is not found or is null/undefined for the latest quarter
        }


        // Update insights panels (summary charts and text)
        async function updateInsightsPanels(process, year, kpis) {
            // Update KPI Status Summary
            const statusSummary = calculateKPIStatusSummary(kpis, process, year);
            document.getElementById('kpi-status-good').textContent = statusSummary.good;
            document.getElementById('kpi-status-warning').textContent = statusSummary.warning;
            document.getElementById('kpi-status-critical').textContent = statusSummary.critical;

            // Update status chart
            updateStatusChart(statusSummary.good, statusSummary.warning, statusSummary.critical);

            const alertsContainer = document.getElementById('critical-alerts');
            alertsContainer.innerHTML = statusSummary.criticalAlerts.length > 0
                ? statusSummary.criticalAlerts.map(alert => `
                    <div class="alert-item text-critical text-red-600 dark:text-red-400">
                        <span class="font-bold">${alert.name}:</span>
                        <span>${alert.message}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 dark:text-gray-400">No critical alerts</p>';

            // Update Year-over-Year Comparison
            const yoy = await calculateYoYComparison(process, year);
            document.getElementById('yoy-improved').textContent = yoy.improved;
            document.getElementById('yoy-declined').textContent = yoy.declined;
            document.getElementById('total-kpis').textContent = yoy.totalKpis;

            // Update Overall Compliance Rate
            const complianceRate = calculateComplianceRate(kpis, process);
            document.getElementById('compliance-rate').textContent = `${complianceRate.toFixed(1)}%`;

            // Update YoY chart
            updateYoYChart(yoy.improved, yoy.declined);
        }

        // Load KPIs for a process and year
        async function loadKPIs(process, year) {
            if (!year) {
                console.warn("No year selected");
                document.getElementById(`${process}-kpi-table`).innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-yellow-600 dark:text-yellow-400">
                            Please select a year to view data.
                        </td>
                    </tr>
                `;
                document.getElementById('kpi-status-good').textContent = '0';
                document.getElementById('kpi-status-warning').textContent = '0';
                document.getElementById('kpi-status-critical').textContent = '0';
                document.getElementById('yoy-improved').textContent = '0';
                document.getElementById('yoy-declined').textContent = '0';
                document.getElementById('total-kpis').textContent = '0';
                document.getElementById('compliance-rate').textContent = '0.0%';
                updateStatusChart(0,0,0);
                updateYoYChart(0,0);
                document.getElementById('critical-alerts').innerHTML = '<p class="text-gray-500 dark:text-gray-400">No critical alerts</p>';

                return;
            }

            showLoading(true);

            try {
                let data = fullDatasetCache[process];

                if (!data) {
                    const response = await fetch(`${API_BASE_URL}/${process}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    data = await response.json();
                    fullDatasetCache[process] = data;
                }

                const filteredData = data.filter(item => {
                    const itemYear = extractYearFromQuarter(item.quarter);
                    return itemYear === parseInt(year);
                });

                renderKPITable(process, filteredData);
                await updateInsightsPanels(process, year, filteredData);

            } catch (error) {
                console.error(`Failed to fetch ${process} KPIs:`, error);
                showNotification(`Failed to load ${kpiNameMap[process] || process} data. Please try again later.`, "error");
                document.getElementById(`${process}-kpi-table`).innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-red-500 dark:text-red-400">
                            Failed to load data. Please check console for details.
                        </td>
                    </tr>
                `;
            } finally {
                showLoading(false);
            }
        }

        // Render KPI table with enhanced styling
        function renderKPITable(process, kpis) {
            const tableBody = document.getElementById(`${process}-kpi-table`);
            tableBody.innerHTML = ''; // Clear previous rows

            if (!kpis || kpis.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                            No data available for the selected year and process.
                        </td>
                    </tr>
                `;
                return;
            }

            // Get unique KPI names from the first available data item that has keys
            let kpiNames = [];
            if (kpis.length > 0) {
                kpiNames = Object.keys(kpis[0]).filter(
                    key => !['id', 'quarter', 'run_date'].includes(key)
                );
            }

            if (kpiNames.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-yellow-600 dark:text-yellow-400">
                            No KPI metrics found in the data for this selection.
                        </td>
                    </tr>
                `;
                return;
            }

            kpiNames.forEach((kpiName, index) => {
                // Find the latest data point for this specific KPI across all quarters for the selected year
                const latestDataForKpi = kpis.reduce((latest, current) => {
                    // Only consider current if it has the KPI data
                    if (current[kpiName] === null || current[kpiName] === undefined) {
                        return latest;
                    }
                    if (latest[kpiName] === null || latest[kpiName] === undefined) {
                        return current; // If latest is null, take current (first valid value)
                    }
                    return current.quarter > latest.quarter ? current : latest;
                }, { quarter: '', [kpiName]: null }); // Initialize latest with null KPI value

                const value = latestDataForKpi[kpiName];
                const quarter = latestDataForKpi.quarter ? formatQuarterDisplay(latestDataForKpi.quarter) : 'N/A';
                const status = determineStatus(kpiName, value);

                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${index % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-750'}`; // Alternating row colors
                row.innerHTML = `
                    <td class="kpi-cell kpi-name-cell whitespace-normal">
                        <span class="kpi-number">${index + 1}.</span>
                        ${kpiNameMap[kpiName] || kpiName}
                    </td>
                    <td class="kpi-cell whitespace-nowrap">${quarter}</td>
                    <td class="kpi-cell whitespace-nowrap value-cell ${status}">
                        ${formatValue(kpiName, value)}
                    </td>
                    <td class="kpi-cell whitespace-nowrap">
                        <span class="status-badge ${getStatusClass(status)}">
                            ${getStatusText(status)}
                        </span>
                    </td>
                    <td class="kpi-cell whitespace-nowrap status-cell cursor-pointer" data-kpi="${kpiName}" data-process="${process}" title="Click to view full trend">
                        <div class="w-24 h-8 flex items-center justify-center">
                            <canvas id="mini-trend-${process}-${index}"></canvas>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);

                // Create mini chart for the KPI
                if (fullDatasetCache[process]) {
                    const sortedKpisForMiniChart = [...fullDatasetCache[process]].sort((a, b) => a.quarter.localeCompare(b.quarter));
                    const trendData = sortedKpisForMiniChart.map(kpi => kpi[kpiName]);
                    const quarterLabels = sortedKpisForMiniChart.map(kpi => formatQuarterDisplay(kpi.quarter));

                    if (trendData.some(v => v !== null && v !== undefined && !isNaN(v))) {
                        createMiniChart(`mini-trend-${process}-${index}`, trendData, quarterLabels);
                    } else {
                        // If no valid data for mini-chart, display N/A or a placeholder
                        const miniChartContainer = document.getElementById(`mini-trend-${process}-${index}`).parentElement;
                        if (miniChartContainer) {
                            miniChartContainer.innerHTML = '<span class="text-gray-400 text-xs">No Trend</span>';
                        }
                    }
                }
            });
        }

        // Set up theme toggle functionality
        function setupThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');

            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            const applyTheme = (isDark) => {
                document.documentElement.classList.toggle('dark', isDark);
                document.documentElement.classList.toggle('light', !isDark);

                themeIconLight.classList.toggle('hidden', isDark);
                themeIconDark.classList.toggle('hidden', !isDark);

                // Update charts to respect new theme colors
                Object.values(chartInstances).forEach(chart => {
                    if (chart) {
                        chart.options.plugins.legend.labels.color = getComputedStyle(document.documentElement).getPropertyValue('--color-text-light');
                        if (chart.options.scales.x) chart.options.scales.x.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--color-text-light');
                        if (chart.options.scales.y) chart.options.scales.y.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--color-text-light');
                        if (chart.data.datasets[0].borderColor) {
                            // Re-apply static colors, or allow segment callback to re-evaluate
                            if (chart.id !== 'trendline') { // trendline plugin
                                if (chart.canvas.id === 'trend-chart') {
                                    chart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green');
                                    chart.data.datasets[0].pointBackgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green');
                                } else if (chart.canvas.id === 'status-chart') {
                                    chart.data.datasets[0].backgroundColor = [
                                        getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32',
                                        getComputedStyle(document.documentElement).getPropertyValue('--color-warning-orange') || '#F59E0B',
                                        getComputedStyle(document.documentElement).getPropertyValue('--color-critical-red') || '#DC2626'
                                    ];
                                    chart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--color-bg-card-light');
                                } else if (chart.canvas.id === 'yoy-chart') {
                                    chart.data.datasets[0].backgroundColor = [
                                        getComputedStyle(document.documentElement).getPropertyValue('--color-primary-green') || '#2E7D32',
                                        getComputedStyle(document.documentElement).getPropertyValue('--color-critical-red') || '#DC2626'
                                    ];
                                    chart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--color-bg-card-light');
                                } else { // Mini charts
                                     chart.data.datasets[0].borderColor = '#A78BFA'; // Keep fixed for mini chart contrast
                                     chart.data.datasets[0].backgroundColor = 'rgba(167, 139, 250, 0.1)';
                                }
                            }
                        }
                        chart.update();
                    }
                });
            };

            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                applyTheme(true);
            } else {
                applyTheme(false);
            }

            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                applyTheme(!isDark);
                localStorage.setItem('theme', !isDark ? 'dark' : 'light');
            });
        }

        // Export data for selected year
        async function exportSelectedYears() {
            const year = document.getElementById('year-filter').value;
            if (!year) {
                showNotification("Please select a year to export data.", "warning");
                return;
            }

            showLoading(true);
            try {
                let allDataForYear = {};
                const processes = ['ma', 'ct', 'gmp'];

                for (const process of processes) {
                    let data = fullDatasetCache[process];
                    if (!data) {
                        const response = await fetch(`${API_BASE_URL}/${process}`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        data = await response.json();
                        fullDatasetCache[process] = data; // Cache it for future use
                    }
                    const filteredData = data.filter(item => extractYearFromQuarter(item.quarter) === parseInt(year));
                    allDataForYear[process] = filteredData;
                }

                const jsonString = JSON.stringify(allDataForYear, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kpi_data_${year}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification(`KPI data for ${year} exported successfully!`, "success");

            } catch (error) {
                console.error("Error exporting data:", error);
                showNotification("Failed to export data for selected year.", "error");
            } finally {
                showLoading(false);
            }
        }

        // Export all available data
        async function exportAllData() {
            showLoading(true);
            try {
                let allData = {};
                const processes = ['ma', 'ct', 'gmp'];

                for (const process of processes) {
                    let data = fullDatasetCache[process];
                    if (!data) {
                        const response = await fetch(`${API_BASE_URL}/${process}`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        data = await response.json();
                        fullDatasetCache[process] = data; // Cache it for future use
                    }
                    allData[process] = data;
                }

                const jsonString = JSON.stringify(allData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kpi_data_all_years.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification("All KPI data exported successfully!", "success");

            } catch (error) {
                console.error("Error exporting all data:", error);
                showNotification("Failed to export all data.", "error");
            } finally {
                showLoading(false);
            }
        }


        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('enter-dashboard-btn').addEventListener('click', function() {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('dashboard-page').classList.remove('hidden');

                const year = document.getElementById('year-filter').value;
                const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                if (year && activeTab) {
                    loadKPIs(activeTab, year);
                }
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const tab = this.getAttribute('data-tab');
                    const year = document.getElementById('year-filter').value;

                    // Remove active classes from all tabs
                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.classList.remove('active', 'scale-105');
                    });

                    // Add active classes to the clicked tab with animation
                    this.classList.add('active', 'scale-105');
                    setTimeout(() => {
                        this.classList.remove('scale-105');
                    }, 300);

                    // Hide all tab content and remove animation class
                    document.querySelectorAll('.tab-content').forEach(c => {
                        c.classList.add('hidden');
                        c.classList.remove('animate-fadeIn');
                    });
                    
                    // Show the active tab content and add animation class
                    const activeTabContent = document.getElementById(`${tab}-tab`);
                    activeTabContent.classList.remove('hidden');
                    activeTabContent.classList.add('animate-fadeIn');

                    if (year) {
                        await loadKPIs(tab, year);
                    }
                });
            });

            document.getElementById('year-filter').addEventListener('change', async function() {
                const year = this.value;
                const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');

                if (year) {
                    await loadKPIs(activeTab, year);
                }
            });

            // Event listener for clicking on mini-trend cells to show full trend
            document.addEventListener('click', function(e) {
                const cell = e.target.closest('.status-cell');
                if (cell) {
                    const kpiName = cell.getAttribute('data-kpi');
                    const process = cell.getAttribute('data-process');
                    showTrendChart(kpiName, process);
                }
            });

            // Close trend modal
            document.getElementById('close-trend-modal').addEventListener('click', function() {
                document.querySelector('#trend-modal .modal-content').classList.add('scale-95', 'opacity-0');
                document.querySelector('#trend-modal .modal-content').classList.remove('scale-100', 'opacity-100');
                document.getElementById('trend-modal').addEventListener('transitionend', function handler() {
                    this.classList.add('hidden');
                    this.removeEventListener('transitionend', handler);
                }, { once: true });
            });
            // Close modal by clicking outside or pressing Escape
            document.getElementById('trend-modal').addEventListener('click', function(e) {
                if (e.target === this) { // Only close if clicking the overlay, not the modal content itself
                    document.querySelector('#trend-modal .modal-content').classList.add('scale-95', 'opacity-0');
                    document.querySelector('#trend-modal .modal-content').classList.remove('scale-100', 'opacity-100');
                    this.addEventListener('transitionend', function handler() {
                        this.classList.add('hidden');
                        this.removeEventListener('transitionend', handler);
                    }, { once: true });
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !document.getElementById('trend-modal').classList.contains('hidden')) {
                    document.querySelector('#trend-modal .modal-content').classList.add('scale-95', 'opacity-0');
                    document.querySelector('#trend-modal .modal-content').classList.remove('scale-100', 'opacity-100');
                    document.getElementById('trend-modal').addEventListener('transitionend', function handler() {
                        this.classList.add('hidden');
                        this.removeEventListener('transitionend', handler);
                    }, { once: true });
                }
            });

            // Export buttons
            document.getElementById('export-selected-btn').addEventListener('click', exportSelectedYears);
            document.getElementById('export-all-btn').addEventListener('click', exportAllData);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>